---
title: "USMAPAO"
author: "D/Math LTC Clark, MAJ Turner, CPT Adams"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    theme: united
    highlight: tango
    toc: true
    toc_depth: 2
    toc_float: true
    smooth_scroll: TRUE
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)
```

# Overview

The following analysis is provided to the USMA PAO on behalf of the CDAS in the Department of MAthematical Sciences.  The purpose is to gain insight into the social media landscape surrounding the the United States Military Academy at West Point.

----

# Download Most Recent Tweets

```{r gettweets, echo=FALSE}
library(shiny)
ui <- fluidPage(
  tags$h3("Functionality Currently Not Working"),
  tags$head(tags$script(src = "message-handler.js")),
  actionButton("do", "Update Tweets")
)

server <- function(input, output, session) {
  observeEvent(input$do, {
    session$sendCustomMessage(type = 'testmessage',
      message = 'Thank you for clicking')
  })
  observeEvent(input$do, {
    data = tibble(x=rnorm(100),y=rnorm(100))
    write.csv(data,"testing.csv")
  })
}

shinyApp(ui = ui, server = server, options = list(height=100))

```

----

```{r include=FALSE}
library(tidyverse)
library(tidytext)
library(lubridate)
added = read_csv("PAOTweets.csv")

textcleaned = added %>%
  unnest_tokens(word, text)

cleanedarticle = anti_join(textcleaned,stop_words, by = "word") %>% select(line,word,screenname,time,followerscount,favoritescount, searchterm)

cleanedarticleleaflet = anti_join(textcleaned,stop_words, by = "word") %>% select(line,word,screenname,time,followerscount,favoritescount, searchterm,lat,lng)

mintime = min(cleanedarticle$time)
```

----

# Sentiment Analysis (Users and Words)

The Plot tab below shows the number of words with both positive and negative sentiment by day.

The table tab below shows the words with sentiment by user, time, follower count, and favorite count.  


```{r panels, echo=FALSE}
library(shiny)
ui <- fluidPage(
  dateRangeInput('dateRange',
    label = 'Please use the filter below to narrow your search criteria between dates of interest.',
    start = mintime,
    end = Sys.Date()),
  tabsetPanel(type = "tabs",
              tabPanel("Plot", plotOutput("sentovertime")),
              tabPanel("Words in Tweets", dataTableOutput("tweettable")
   )
  )
)
server <- function(input, output) {
   
  dataset = reactive({
    filtered = cleanedarticle %>%
    full_join(get_sentiments("nrc"), by = "word") %>%
    filter(searchterm == "USMA" | searchterm == "WestPoint") %>%
    # select(-c(location,lat,lng,coords_coords,bbox_coords,geo_coords)) %>%
    filter(complete.cases(.)) %>%
    filter(sentiment == "positive" | sentiment == "negative") %>%
    mutate(time = floor_date(time, unit = "day")) %>%
    mutate(dayofweek = weekdays(time)) %>%
    filter(time <= input$dateRange[2]) %>%
    filter(time >= input$dateRange[1])
    return(filtered)
  })
  
  output$sentovertime = renderPlot({
    ggplot(dataset(), aes(sentiment, fill = sentiment)) +
    geom_bar() +
    facet_wrap(time ~ dayofweek, ncol = 7)
  })
  
  output$text = renderText({
    this = as.character(input$dateRange)
    this = this[2]
    return(this)
  })

  output$tweettable = renderDataTable({
    return(dataset())
  })
  
}

shinyApp(ui = ui, server = server, options = list(height=600))

```

----

# Sentiment Analysis (Users and Tweets)

During the selected time period, the following users "netted" the following amounts of sentiment in their words throughout all their tweets.  

The Favorites Count tallys the total number of favorites among all their tweets during this time period.  

```{r influentialtweets, echo=FALSE}
library(shiny)
ui <- fluidPage(
    dateRangeInput('dateRange',
    label = 'Please use the filter below to narrow your search criteria between dates of interest.',
    start = mintime,
    end = Sys.Date()
  ),
    tabsetPanel(type = "tabs",
              tabPanel("Influential Users", 
                       # radioButtons("sent","Sentiment of Interest:",
                       #   choices = c("Positive" = "positive","Negative" = "negative")
                       #   ),
                       dataTableOutput("tweettable")), 
              tabPanel("Full Tweets", 
                       # tags$h3("Tweets Not Filtered By Sentiment"),
                       dataTableOutput("tweettable2"))
              )
  )
  

server <- function(input, output) {
  dataset = reactive({
    filtered = 
      cleanedarticle %>%
  full_join(get_sentiments("nrc"), by = "word") %>%
  # select(-c(location,lat,lng,coords_coords,bbox_coords,geo_coords)) %>%
  filter(complete.cases(.)) %>%
  filter(sentiment=="positive" | sentiment == "negative") %>%
  filter(searchterm == "USMA" | searchterm == "WestPoint") %>%
  mutate(time = floor_date(time, unit = "day")) %>%
  mutate(dayofweek = weekdays(time)) %>%
  filter(time <= input$dateRange[2]) %>%
  filter(time >= input$dateRange[1]) %>%
  arrange(desc(followerscount)) %>%
  group_by(screenname,sentiment) %>%
  mutate(total = n()) %>%
  distinct(screenname,sentiment, followerscount,favoritescount,total) %>%
  # filter(sentiment==input$sent) %>%
  ungroup() %>%
  mutate(total = ifelse(sentiment=="negative",total*-1,total)) %>%
  group_by(screenname) %>%
  summarise(FollowersCount = max(followerscount), 
            FavoritesCount = sum(favoritescount), 
            Net_Pos_Words = sum(total), Total_Sentament_Words = sum(abs(total))) %>%
  arrange(desc(Net_Pos_Words)) 
    return(filtered)
  })

  output$tweettable = renderDataTable(dataset(),{
   options = list(pageLength = 10)
  })
 
    dataset2 = reactive({
    filtered = added %>%
    mutate(time = floor_date(time, unit = "day")) %>%
    mutate(dayofweek = weekdays(time)) %>%
    filter(time <= input$dateRange[2]) %>%
    filter(time >= input$dateRange[1]) %>%
      select(screenname, text, time)
    return(filtered)
  })
  

  output$tweettable2 = renderDataTable(dataset2(),{
   options = list(pageLength = 10)
  })
  
   
}

shinyApp(ui = ui, server = server, options = list(height=1200))

```

----

# Sentiment Analysis Polarity (Users and Full Tweets)

The Plot tab below shows the number of words with both positive and negative sentiment by day.

The table tab below shows the words with sentiment by user, time, follower count, and favorite count.  


```{r polarity, echo=FALSE}
library(shiny)
library(sentimentr)
ui <- fluidPage(
  dateRangeInput('dateRange',
    label = 'Please use the filter below to narrow your search criteria between dates of interest.',
    start = mintime,
    end = Sys.Date()),
  tabsetPanel(type = "tabs",
              tabPanel("Plot", plotOutput("sentovertime")),
              tabPanel("Words in Tweets", dataTableOutput("tweettable")
   )
  )
)
server <- function(input, output) {
   
  dataset = reactive({
    converted = added %>%
      select(-lat,-lng,-coords_coords,-bbox_coords,-geo_coords) %>%
      mutate(text = iconv(text, "UTF-8", "UTF-8",sub='')) 

    senttest = get_sentences(converted$text)
    scores_by = sentiment_by(senttest)

    added2 = converted %>%
      mutate(polaritysent = scores_by$ave_sentiment) 
    return(added2)
  })
  
  output$sentovertime = renderPlot({
    ggplot(dataset(), aes(sentiment, fill = sentiment)) +
    geom_bar() +
    facet_wrap(time ~ dayofweek, ncol = 7)
  })
  
  # output$text = renderText({
  #   this = as.character(input$dateRange)
  #   this = this[2]
  #   return(this)
  # })

  output$tweettable = renderDataTable({
    return(dataset())
  })
  
}

shinyApp(ui = ui, server = server, options = list(height=600, width = 1200))

```



----


# Social Heartbeat

```{r singletweets, echo=FALSE}
library(shiny)
ui <- fluidPage(
  radioButtons("option","Plot Type:",
                         choices = c("Ridged" = "riged","Smooth" = "smooth")
                         ),
  plotOutput("heartbeat")
)


server <- function(input, output) {

  dataset = reactive({
    filtered =  cleanedarticle %>%
    mutate(Academy = case_when(searchterm=="USMA" ~ "West Point",
                             searchterm=="WestPoint" ~ "West Point",
                             searchterm=="USNA" ~ "Navy",
                             searchterm=="United States NAval Academy" ~ "Navy",
                             searchterm=="Air Force Academy" ~ "Air Force",
                             searchterm=="USAFA" ~ "Air Force")) %>%
    full_join(get_sentiments("nrc"), by = "word") %>%
    filter(complete.cases(.)) %>%
    filter(sentiment == "positive" | sentiment == "negative") %>%
    mutate(time = floor_date(time, unit = "day")) %>%
    mutate(score = ifelse(sentiment == "positive", 1, -1)) %>%
    group_by(time, Academy) %>%
    summarise(dayscore = sum(score) / sum(abs(score))) 
      return(filtered)
  })
  

  output$heartbeat = renderPlot({
    if (input$option == "riged") {
    dataset() %>%
    ggplot(aes(time, dayscore, color = Academy)) +
    geom_line() +
    # geom_smooth() +
    theme(legend.position = "bottom") +
    labs(title = "Reputation Heartbeat", x = "Date", y = "Sentiment Score") +
    ylim(-1,1)
    } else if (input$option == "smooth") {
    dataset() %>%
    ggplot(aes(time, dayscore, color = Academy)) +
    geom_smooth(span = .3) +
    theme(legend.position = "bottom") +
    labs(title = "Reputation Heartbeat", x = "Date", y = "Sentiment Score") +
    ylim(-1,1)
    }
  })
  
}

shinyApp(ui = ui, server = server, options = list(height=800))

```

----

# Where are People Tweeting About USMA

```{r map, echo=FALSE}
library(shiny)
library(leaflet)
library(htmltools)
ui <- fluidPage(
leafletOutput("mymap")
)


server <- function(input, output) {

 output$mymap <- renderLeaflet({
   
   added %>% 
  filter(!is.na(lat)) %>%
  leaflet() %>% setView(-100, 40, zoom = 4) %>%
  addTiles() %>% # Add default OpenStreetMap map tiles
  addMarkers(~lng,~lat,popup = ~as.character(screenname), clusterOptions = markerClusterOptions())
  # addMarkers(~lng,~lat,popup = ~as.character(screenname), label = ~as.character(text), clusterOptions = markerClusterOptions())

  })
  
}

shinyApp(ui = ui, server = server, options = list(height=800))

```

----
